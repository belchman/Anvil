# Development Process

This document defines how Anvil's pipeline structures work from requirements to shipped code. Following this process prevents the most common autonomous agent failure modes: context loss, hallucinated requirements, untested code, and runaway costs.

## Core Principle: Spec Before Code

Outside-in Behavior-Driven Development (BDD). Every change follows: interrogate → document → specify → implement → verify → ship.

- Describe behavior in English first (user stories with acceptance criteria)
- Translate behavior into executable specifications (test cases, Gherkin features, or holdout scenarios)
- Run specifications and confirm they fail (red phase)
- Write only the code required to make them pass (green phase)
- Refactor while all specifications remain green
- Tag all assumptions: `[ASSUMPTION: rationale]` with confidence (HIGH/MEDIUM/LOW)

## Running the Pipeline

Always run from the repository root.

```bash
# Autonomous mode
anvil run "TICKET-ID"

# Resume a previous run
anvil run "TICKET-ID" --resume docs/artifacts/pipeline-runs/2026-02-23-1430

# Interactive mode
claude
# then: /phase0 -> follow prompts

# Quick feature addition
claude
# then: /feature-add "description"
```

## Pipeline Tiers

Tiers control which phases run, balancing cost against rigor:

| Tier | Cost | Phases | Use when |
|------|------|--------|----------|
| nano | $3-5 | context scan + implement + verify + ship | Trivial changes, config, typos |
| quick | $8-15 | + spec writing | Small features, well-defined tasks |
| lite | $12-18 | + holdout validation | Medium features where correctness matters |
| standard | $20-30 | + doc generation + reviews | Most feature work |
| full | $40-50 | + security audit + dual-pass review | Production, security-sensitive changes |

Set `PIPELINE_TIER` in `anvil.toml` or let auto-detection handle it. Default: `auto` (phase0 estimates scope 1-5, maps to tier).

## Phase Order

`phase0` → `interrogate` → `interrogation-review` → `generate-docs` → `doc-review` → `write-specs` → `holdout-generate` → `implement` → `holdout-validate` → `security-audit` → `ship`

Phase ordering is defined in the pipeline orchestrator.

## Configuration

`anvil.toml` is the single source of configuration. All thresholds, timeouts, models, budgets, and paths live there.

When adding a new config variable:
1. Add it to `anvil.toml` with a comment
2. Add corresponding field to `src/config.rs`
3. Use TOML section naming: `[anvil]`, `[turns]`, `[budget]`, `[quality]`, `[watchdog]`, `[paths]`, `[models]`, `[timeouts]`

## Cross-Model BDD

In autonomous pipeline mode, different models handle different phases to eliminate same-brain bias:

- **Sonnet** writes failing specifications (red phase) in `write-specs`
- **Opus** implements code to make specs pass (green phase)
- **Holdouts**: generated by one model, validated by another, never shown to the implementing agent

When `write-specs` is skipped (quick/nano tiers), the implementing model performs all BDD phases as a single agent.

## External Review Validators

The `REVIEW_VALIDATOR_COMMAND` config option breaks the same-model-family limitation. Set it to pipe review output to a non-Anthropic model, static analyzer, or human review script. The strictest verdict across all passes wins. This turns LLM-as-judge from "Claude reviewing Claude" into "Claude + external validator reviewing Claude."

## Human Gates

Set `HUMAN_GATES="write-specs,doc-review"` to pause the pipeline for human approval at specific phases. The pipeline exits with code 2 and resumes with `--resume` after the human creates a `.human-approved` marker file.

## Adaptive Template Selection

`DOC_TEMPLATES_MODE` avoids generating unnecessary documents. In `auto` mode, only templates relevant to the detected project type are generated. A CLI tool skips FRONTEND_GUIDELINES.md. A service without a database skips DATA_MODELS.md. Set to `minimal` for just PRD + implementation plan + testing plan.

## Gate Thresholds

| Gate | Threshold | On failure |
|------|-----------|------------|
| Interrogation review | `THRESHOLD_PASS` | Iterate or block |
| Doc review | `THRESHOLD_DOC_REVIEW` | Iterate |
| Verify | PASS/FAIL | Retry up to `MAX_VERIFY_RETRIES`, then block |
| Holdout validation | `THRESHOLD_HOLDOUT` + zero anti-patterns | Route back to implement |
| Security audit | Zero BLOCKERs | Auto-fix, then re-audit |
| Ship | All green | Create PR |

Review gates use dual-pass evaluation with cross-model diversity and position bias mitigation. Stricter verdict wins.

## Circuit Breakers

- **Kill switch**: Create `.pipeline-kill` to halt immediately
- **Cost ceiling**: `MAX_PIPELINE_COST` stops the pipeline if exceeded
- **Per-phase limits**: `TURNS_*`, `BUDGET_*`, `TIMEOUT_*` per phase
- **Stagnation detection**: similar errors across retries triggers reroute
- **Progress tracking**: consecutive phases without git commits = stall

## Context Discipline

Context windows are finite. The pipeline manages them explicitly:

- **Fidelity modes** control how much prior-phase context loads: `full` | `truncate` | `compact` | `summary:high/medium/low`
- **Auto-adjustment**: when estimated context exceeds threshold, downgrade fidelity
- **Compaction**: output > 200 lines → pyramid summary. Phase boundary → artifact + summary, start fresh
- **Large outputs** go to `${ARTIFACTS_DIR}/` (Tier 3), not conversation

## Assumptions Policy

- **Interactive mode**: never guess, ask the human
- **Autonomous mode**: search MCP sources → infer from codebase patterns → assume with `[ASSUMPTION: rationale]` tag
- LOW confidence assumptions on critical topics (auth, compliance, data retention) → `[NEEDS_HUMAN]`

## Portability

- No `grep -oP` (not portable to macOS/BSD)
- No hardcoded paths when config variables exist
- TTY-aware colors with `if [ -t 1 ]` checks
- All config centralized in `anvil.toml`
- Validate with `anvil test` (131 checks, zero failures required)

## Commit Discipline

- Commit after each verified implementation step
- Conventional format: `feat(step-id): title`, `fix(security): description`
- Never commit secrets, credentials, or `.env` files
- The human user is the sole author. Claude is never listed as co-author.
